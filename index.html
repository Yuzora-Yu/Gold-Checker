<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Prisma Gold Pro - Elite Dashboard</title>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root {
            --bg-color: #131722; --panel-bg: #1e222d; --border-color: #363c4e;
            --buy-color: #089981; --sell-color: #f23645; --gold-color: #ff9800;
            --warn-color: #fbc02d; --text-main: #d1d4dc; --update-color: #ff9800; --cisd-color: #2196f3;
        }

        body { 
            background: var(--bg-color); color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            transition: all 0.5s ease;
        }

        body.golden-glow { box-shadow: inset 0 0 100px var(--buy-color); background-color: #052e21; }
        body.death-glow { box-shadow: inset 0 0 100px var(--sell-color); background-color: #3d0e14; }
        body.sync-active { box-shadow: inset 0 0 80px rgba(33, 150, 243, 0.2); }

        .header-panel {
            display: flex; justify-content: center; align-items: center;
            padding: 15px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); gap: 40px;
        }
        .score-box { text-align: center; }
        .score-val { font-size: 38px; font-weight: bold; line-height: 1; }
        .score-lab { font-size: 11px; color: #848e9c; margin-top: 5px; text-transform: uppercase; }

        .dashboard-main { display: flex; flex: 1; overflow: hidden; }
        #gold-chart { flex: 1; border-right: 1px solid var(--border-color); }

        .side-panel { width: 320px; display: flex; flex-direction: column; background: var(--panel-bg); padding: 15px; gap: 12px; overflow-y: auto; }
        .info-card { padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid #848e9c; }
        .card-lab { font-size: 10px; color: #848e9c; margin-bottom: 4px; }
        .card-val { font-size: 17px; font-weight: bold; font-family: monospace; }
        .card-desc { font-size: 10px; color: #b2b5be; margin-top: 4px; line-height: 1.2; }

        #sync-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; background: #363c4e; color: #848e9c; }
        #sync-badge.active { background: var(--cisd-color); color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .gauge-container { width: 100%; height: 20px; background: #363c4e; border-radius: 10px; overflow: hidden; display: flex; margin: 8px 0; }
        #buy-bar { height: 100%; background: var(--buy-color); transition: width 0.8s ease; }
        #sell-bar { height: 100%; background: var(--sell-color); transition: width 0.8s ease; }

        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
        .action-btn { width: 100%; border: none; color: white; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .copy-btn { background: #5d606b; }
        .update-btn { background: var(--update-color); }
        .update-input { width: 92%; background: #131722; border: 1px solid var(--border-color); color: white; padding: 5px; margin-bottom: 4px; border-radius: 4px; font-size: 12px; outline: none; }
    </style>
</head>
<body>

    <div class="header-panel">
        <div class="score-box">
            <div id="main-score" class="score-val">0</div>
            <div class="score-lab">çŸ­æœŸã‚·ã‚°ãƒŠãƒ« (1H)</div>
        </div>
        <div class="score-box">
            <div id="score-4h" class="score-val">0</div>
            <div class="score-lab">é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ (4H)</div>
        </div>
        <div style="text-align: center; border-left: 1px solid var(--border-color); padding-left: 20px;">
            <div id="price-display" style="font-size: 24px; font-weight: bold; line-height: 1;">$0.00</div>
            <div style="font-size: 9px; color: #848e9c; margin-bottom: 4px;">Yahoo Finance (é‡‘å…ˆç‰© GC=F)</div>
            <div id="sync-badge">5m/30m åŒæœŸ: å¾…æ©Ÿ</div>
        </div>
    </div>

    <div class="dashboard-main">
        <div id="gold-chart"></div>

        <div class="side-panel">
            <div id="vol-spike-msg" style="color: var(--gold-color); font-weight: bold; font-size: 11px; display: none; text-align: center;">âš ï¸ å¤§å£ä»‹å…¥(å‡ºæ¥é«˜ã‚¹ãƒ‘ã‚¤ã‚¯)ã‚’æ¤œçŸ¥</div>

            <div class="info-card" style="border-left-color: var(--cisd-color);">
                <div class="card-lab">â‘  CISD (æ©Ÿé–¢æŠ•è³‡å®¶ã®éœ€çµ¦ãƒã‚¤ãƒ³ãƒˆ)</div>
                <div id="cisd-res" class="card-val" style="color: var(--sell-color); font-size: 15px;">Res: $0.00</div>
                <div id="cisd-sup" class="card-val" style="color: var(--buy-color); font-size: 15px;">Sup: $0.00</div>
                <div class="card-desc">å¤§å£ã®æ³¨æ–‡ãŒæºœã¾ã£ã¦ã„ã‚‹å£ã€‚åç™ºã¾ãŸã¯åŠ é€Ÿã®èµ·ç‚¹ã€‚</div>
            </div>

            <div class="info-card" style="border-left-color: var(--gold-color);">
                <div class="card-lab">â‘¡ çœŸç©ºåœ°å¸¯ (åŠ é€Ÿã‚¨ãƒªã‚¢)</div>
                <div id="vacuum-list" style="font-size: 13px; font-family: monospace;">æ¤œçŸ¥ãªã—</div>
                <div class="card-desc">å‡ºæ¥é«˜ã®æ¥µç«¯ã«è–„ã„åœ°å¸¯ã€‚ä¾¡æ ¼ãŒåŠ é€Ÿã—ã‚„ã™ã„é ˜åŸŸã€‚</div>
            </div>

            <div class="info-card">
                <div class="card-lab">å¸‚å ´å‹¢åŠ›å›³ (BUY vs SELL)</div>
                <div class="gauge-container">
                    <div id="buy-bar" style="width: 50%;"></div>
                    <div id="sell-bar" style="width: 50%;"></div>
                </div>
                <div id="pressure-text" style="font-weight: bold; font-size: 12px; text-align: center;">50% / 50%</div>
                <div class="card-desc" style="margin-top:5px; text-align:center;">
                    DXYç›¸é–¢: <span id="corr-val" style="font-weight: bold;">0.00</span> / RSI: <span id="rsi-val">0</span>
                </div>
            </div>

            <div id="ai-advice-card" class="info-card">
                <div id="ai-status" style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">è§£æä¸­...</div>
                <div id="ai-reason" style="font-size: 12px; line-height: 1.4; color: #b2b5be;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚</div>
            </div>

            <div class="btn-group">
                <button onclick="copyReport()" class="action-btn copy-btn">ğŸ“‹ AIåˆ†æç”¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 4px;">
                    <input type="password" id="gh-token" class="update-input" placeholder="GitHub Tokenã‚’å…¥åŠ›">
                    <button onclick="triggerWorkflow()" id="btn-update" class="action-btn update-btn">Botæ‰‹å‹•å®Ÿè¡Œ</button>
                    <div id="update-status" style="font-size: 9px; color: var(--update-color); margin-top: 4px; text-align: center;">Update: <span id="last-update">----/--/-- --:--</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        new TradingView.widget({ "container_id": "gold-chart", "autosize": true, "symbol": "OANDA:XAUUSD", "interval": "15", "theme": "dark", "style": "1", "locale": "ja", "withdateranges": true });

        let currentData = null;
        document.getElementById('gh-token').value = localStorage.getItem('gh_pat') || '';

        async function refreshData() {
            try {
                const res = await fetch('./data.json?' + Date.now());
                currentData = await res.json();
                
                // å®‰å…¨ãªè¦ç´ ã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
                const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };

                set('main-score', (currentData.score_1h > 0 ? '+' : '') + currentData.score_1h);
                set('score-4h', (currentData.score_4h > 0 ? '+' : '') + currentData.score_4h);
                set('price-display', `$${currentData.price.toLocaleString()}`);

                const corrElem = document.getElementById('corr-val');
                if (corrElem) {
                    if (currentData.correlation === "Error") {
                        corrElem.textContent = "å–å¾—å¤±æ•—";
                        corrElem.style.color = "var(--sell-color)";
                    } else {
                        corrElem.textContent = currentData.correlation;
                        corrElem.style.color = "inherit";
                    }
                }

                set('rsi-val', currentData.rsi);
                set('cisd-res', `Res: $${currentData.cisd_high}`);
                set('cisd-sup', `Sup: $${currentData.cisd_low}`);
                
                const vList = document.getElementById('vacuum-list');
                if(vList) vList.innerHTML = currentData.vacuum_zones.length ? currentData.vacuum_zones.map(z => `<div>${z.from} - ${z.to}</div>`).join('') : "æ¤œçŸ¥ãªã—";
                
                set('last-update', currentData.update_time);

                const badge = document.getElementById('sync-badge');
                if (badge) {
                    if (currentData.is_synced) {
                        badge.textContent = `âœ¨ åŒæœŸä¸­ (${currentData.sync_dir})`; badge.classList.add('active');
                        document.body.classList.add('sync-active');
                    } else {
                        badge.textContent = "5m/30m åŒæœŸ: å¾…æ©Ÿ"; badge.classList.remove('active');
                        document.body.classList.remove('sync-active');
                    }
                }

                document.body.classList.remove('golden-glow', 'death-glow');
                if (currentData.is_golden) document.body.classList.add('golden-glow');
                else if (currentData.is_death) document.body.classList.add('death-glow');

                const buyP = currentData.buy_ratio;
                const bBar = document.getElementById('buy-bar');
                const sBar = document.getElementById('sell-bar');
                if(bBar) bBar.style.width = buyP + '%';
                if(sBar) sBar.style.width = (100 - buyP) + '%';
                set('pressure-text', `${buyP}% / ${100 - buyP}%`);
                
                set('ai-status', currentData.status);
                set('ai-reason', currentData.reason);
                
                const aiCard = document.getElementById('ai-advice-card');
                if(aiCard) {
                    // è­¦å‘Šãƒ»æ³¨æ„ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯é»„è‰²ã€ãã‚Œä»¥å¤–ã¯ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦èµ¤ãƒ»ç·‘
                    if (currentData.status.includes('âš ï¸') || currentData.status.includes('æ³¨æ„') || currentData.status.includes('é€†è¡Œ')) {
                        aiCard.style.borderLeftColor = 'var(--warn-color)';
                    } else {
                        aiCard.style.borderLeftColor = currentData.score_1h > 0 ? 'var(--buy-color)' : 'var(--sell-color)';
                    }
                }
                
                const spikeMsg = document.getElementById('vol-spike-msg');
                if(spikeMsg) spikeMsg.style.display = currentData.vol_spike ? 'block' : 'none';

            } catch (e) { console.error("Refresh error:", e); }
        }

        function copyReport() {
            if (!currentData) return;
            
            // å ±å‘Šæ›¸ã¨ã—ã¦ä¸é©åˆ‡ãªçµµæ–‡å­—ã‚’é™¤å»
            const cleanStatus = currentData.status.replace(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/g, '').trim();
            
            const report = `
ã€Gold Analysis Report: ${currentData.update_time}ã€‘
â— Price: $${currentData.price} (å–å¾—å…ƒ: GC=F)
â— Score: 1H(${currentData.score_1h}) / 4H(${currentData.score_4h})
â— Trend: 4H(${currentData.trend_4h}) / Sync(${currentData.is_synced ? currentData.sync_dir : 'NONE'})
â— CISD: Res($${currentData.cisd_high}) / Sup($${currentData.cisd_low})
â— AI Status: ${cleanStatus}
â— Reason: ${currentData.reason.replace(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/g, '').trim()}
            `.trim();
            navigator.clipboard.writeText(report);
            alert("å ±å‘Šæ›¸ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆçµµæ–‡å­—é™¤å»æ¸ˆã¿ï¼‰ã€‚");
        }

        async function triggerWorkflow() {
            const token = document.getElementById('gh-token').value;
            const status = document.getElementById('update-status');
            const btn = document.getElementById('btn-update');
            if (!token) { alert("GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            localStorage.setItem('gh_pat', token); status.textContent = "ğŸš€ å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­..."; btn.disabled = true;
            try {
                const response = await fetch(`https://api.github.com/repos/Yuzora-Yu/Gold-Checker/actions/workflows/main.yml/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: 'main' })
                });
                if (response.status === 204) {
                    status.textContent = "â³ è§£æä¸­... åæ˜ ã¾ã§ç´„2åˆ†ãŠå¾…ã¡ãã ã•ã„";
                    setTimeout(() => { status.textContent = "å¾…æ©Ÿä¸­"; btn.disabled = false; }, 120000);
                } else { status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; btn.disabled = false; }
            } catch (e) { status.textContent = "âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼"; btn.disabled = false; }
        }

        refreshData(); setInterval(refreshData, 60000);
    </script>
</body>
</html>