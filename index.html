<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Prisma Gold Pro - Elite Dashboard</title>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #131722; --panel-bg: #1e222d; --border-color: #363c4e;
            --buy-color: #089981; --sell-color: #f23645; --gold-color: #ff9800;
            --text-main: #d1d4dc; --update-color: #ff9800; --cisd-color: #2196f3;
        }

        body { 
            background: var(--bg-color); color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            transition: all 0.5s ease; overflow: hidden;
        }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
        #capture-area { display: flex; flex-direction: column; height: 100%; width: 100%; background: var(--bg-color); }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šæƒ…å ±ã®è¦–èªæ€§å¼·åŒ– */
        .header-panel {
            display: flex; justify-content: center; align-items: center;
            padding: 15px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); gap: 40px;
        }
        .score-display { text-align: center; }
        .score-value { font-size: 38px; font-weight: bold; line-height: 1; }
        .score-label { font-size: 11px; color: #848e9c; margin-top: 5px; text-transform: uppercase; }

        .dashboard-main { display: flex; flex: 1; overflow: hidden; }

        /* å·¦å´ï¼šãƒãƒ£ãƒ¼ãƒˆ (ä¸‹éƒ¨ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãªã—) */
        .charts-container { display: flex; flex-direction: column; flex: 1; border-right: 1px solid var(--border-color); }
        #gold-chart { flex: 2; }
        #dxy-chart { height: 200px; border-top: 1px solid var(--border-color); }

        /* å³å´ï¼šã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        .side-panel { width: 320px; display: flex; flex-direction: column; background: var(--panel-bg); padding: 15px; gap: 12px; overflow-y: auto; }

        .info-card { padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid #848e9c; position: relative; }
        .card-label { font-size: 10px; color: #848e9c; margin-bottom: 4px; }
        .card-value { font-size: 17px; font-weight: bold; font-family: monospace; }
        .card-desc { font-size: 10px; color: #b2b5be; margin-top: 4px; line-height: 1.2; }

        /* åŒæœŸãƒ»ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        #sync-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; background: #363c4e; color: #848e9c; }
        #sync-badge.active { background: var(--cisd-color); color: white; animation: pulse 2s infinite; }
        body.golden-glow { box-shadow: inset 0 0 100px var(--buy-color); background-color: #052e21; }
        body.death-glow { box-shadow: inset 0 0 100px var(--sell-color); background-color: #3d0e14; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
        .action-btn { width: 100%; border: none; color: white; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: opacity 0.2s; }
        .copy-btn { background: #5d606b; }
        .update-btn { background: var(--update-color); }
        .update-input { width: 92%; background: #131722; border: 1px solid var(--border-color); color: white; padding: 5px; margin-bottom: 4px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div id="capture-area">
    <div class="header-panel">
        <div class="score-display">
            <div id="main-score" class="score-value">0</div>
            <div class="score-label">çŸ­æœŸã‚·ã‚°ãƒŠãƒ« (1H)</div>
        </div>
        <div class="score-display">
            <div id="score-4h" class="score-value">0</div>
            <div class="score-label">é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ (4H)</div>
        </div>
        <div style="text-align: center; border-left: 1px solid var(--border-color); padding-left: 20px;">
            <div id="price-display" style="font-size: 24px; font-weight: bold;">$0.00</div>
            <div id="sync-badge">5m/30m åŒæœŸ: å¾…æ©Ÿ</div>
        </div>
    </div>

    <div class="dashboard-main">
        <div class="charts-container">
            <div id="gold-chart"></div>
            <div id="dxy-chart"></div>
        </div>

        <div class="side-panel">
            <div id="vol-spike-msg" style="color: var(--gold-color); font-weight: bold; font-size: 11px; display: none; text-align: center;">âš ï¸ å¤§å£ä»‹å…¥(å‡ºæ¥é«˜ã‚¹ãƒ‘ã‚¤ã‚¯)æ¤œçŸ¥</div>

            <div class="info-card" style="border-left-color: var(--cisd-color);">
                <div class="card-label">â‘  CISD (æ©Ÿé–¢æŠ•è³‡å®¶ã®éœ€çµ¦ã‚¾ãƒ¼ãƒ³)</div>
                <div id="cisd-res" class="card-value" style="color: var(--sell-color);">$0.00</div>
                <div id="cisd-sup" class="card-value" style="color: var(--buy-color);">$0.00</div>
                <div class="card-desc">å¤§å£ã®æ³¨æ–‡ãŒæºœã¾ã£ã¦ã„ã‚‹å£ã€‚åç™ºã®èµ·ç‚¹ã€‚</div>
            </div>

            <div class="info-card" style="border-left-color: var(--gold-color);">
                <div class="card-label">â‘¡ çœŸç©ºåœ°å¸¯ (åŠ é€Ÿã‚¨ãƒªã‚¢)</div>
                <div id="vacuum-list" style="font-size: 13px; font-family: monospace;">æ¤œçŸ¥ãªã—</div>
                <div class="card-desc">å‡ºæ¥é«˜ã®è–„ã„åœ°å¸¯ã€‚ä¾¡æ ¼ãŒåŠ é€Ÿã—ã‚„ã™ã„é ˜åŸŸã€‚</div>
            </div>

            <div class="info-card">
                <div class="card-label">ç’°å¢ƒèªè­˜ãƒ‡ãƒ¼ã‚¿</div>
                <div style="font-size: 12px; display: flex; justify-content: space-between;">
                    <span>DXYç›¸é–¢: <span id="corr-val">0.00</span></span>
                    <span>RSI: <span id="rsi-val">0</span></span>
                </div>
                <div class="card-desc">é€†ç›¸é–¢(-1.0ã«è¿‘ã„ã»ã©æ­£å¸¸)ã¨éç†±æ„Ÿã€‚</div>
            </div>

            <div id="ai-advice-card" class="info-card">
                <div id="ai-status" style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">è§£æä¸­...</div>
                <div id="ai-reason" style="font-size: 12px; line-height: 1.4; color: #b2b5be;">è§£æã‚¨ãƒ³ã‚¸ãƒ³å¾…æ©Ÿä¸­ã€‚</div>
            </div>

            <div class="btn-group">
                <button onclick="copyToClipboard()" class="action-btn copy-btn">ğŸ“‹ ç”»é¢ã‚’ã‚³ãƒ”ãƒ¼ (åˆ†æç”¨)</button>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 4px;">
                    <input type="password" id="gh-token" class="update-input" placeholder="GitHub Token">
                    <button onclick="triggerWorkflow()" id="btn-update" class="action-btn update-btn">Botæ‰‹å‹•å®Ÿè¡Œ</button>
                    <div id="update-status" style="font-size: 9px; color: var(--update-color); margin-top: 4px; text-align: center;">Update: <span id="last-update">----/--/-- --:--</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // TradingView widgets
    new TradingView.widget({ "container_id": "gold-chart", "autosize": true, "symbol": "OANDA:XAUUSD", "interval": "15", "theme": "dark", "style": "1", "locale": "ja", "withdateranges": true });
    new TradingView.widget({ "container_id": "dxy-chart", "autosize": true, "symbol": "CAPITALCOM:DXY", "interval": "15", "theme": "dark", "style": "2", "locale": "ja", "hide_top_toolbar": true, "hide_legend": true });

    document.getElementById('gh-token').value = localStorage.getItem('gh_pat') || '';

    async function refreshData() {
        try {
            const response = await fetch('./data.json?' + Date.now());
            const data = await response.json();

            // ã‚¹ã‚³ã‚¢ãƒ»ä¾¡æ ¼æ›´æ–°
            const s1h = data.score_1h;
            document.getElementById('main-score').textContent = (s1h > 0 ? '+' : '') + s1h;
            document.getElementById('main-score').style.color = s1h > 0 ? 'var(--buy-color)' : 'var(--sell-color)';

            const s4h = data.score_4h;
            document.getElementById('score-4h').textContent = (s4h > 0 ? '+' : '') + s4h;
            document.getElementById('score-4h').style.color = s4h > 0 ? 'var(--buy-color)' : 'var(--sell-color)';

            document.getElementById('price-display').textContent = `$${data.price.toLocaleString()}`;
            document.getElementById('corr-val').textContent = data.correlation;
            document.getElementById('rsi-val').textContent = data.rsi;
            document.getElementById('cisd-res').textContent = `Res: $${data.cisd_high}`;
            document.getElementById('cisd-sup').textContent = `Sup: $${data.cisd_low}`;
            document.getElementById('vacuum-list').innerHTML = data.vacuum_zones.length ? data.vacuum_zones.map(z => `<div>${z.from} - ${z.to}</div>`).join('') : "æ¤œçŸ¥ãªã—";
            document.getElementById('last-update').textContent = data.update_time;

            // åŒæœŸãƒãƒƒã‚¸
            const syncBadge = document.getElementById('sync-badge');
            if (data.is_synced) {
                syncBadge.textContent = `âœ¨ åŒæœŸä¸­ (${data.sync_dir})`; syncBadge.classList.add('active');
            } else {
                syncBadge.textContent = "5m/30m åŒæœŸ: å¾…æ©Ÿ"; syncBadge.classList.remove('active');
            }

            // ã‚·ã‚°ãƒŠãƒ«ç™ºå…‰
            document.body.classList.remove('golden-glow', 'death-glow');
            if (data.is_golden) document.body.classList.add('golden-glow');
            else if (data.is_death) document.body.classList.add('death-glow');

            // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹
            document.getElementById('ai-status').textContent = data.status;
            document.getElementById('ai-reason').textContent = data.reason;
            document.getElementById('ai-advice-card').style.borderLeftColor = s1h > 0 ? 'var(--buy-color)' : 'var(--sell-color)';
            document.getElementById('vol-spike-msg').style.display = data.vol_spike ? 'block' : 'none';

        } catch (e) { console.error(e); }
    }

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½
    async function copyToClipboard() {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = "ğŸ“¸ ç”Ÿæˆä¸­...";
        try {
            const canvas = await html2canvas(document.getElementById('capture-area'), {
                backgroundColor: "#131722",
                useCORS: true,
                scale: 1.5 // è§£åƒåº¦ã‚¢ãƒƒãƒ—
            });
            canvas.toBlob(blob => {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]);
                btn.textContent = "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
                setTimeout(() => btn.textContent = "ğŸ“‹ ç”»é¢ã‚’ã‚³ãƒ”ãƒ¼ (åˆ†æç”¨)", 3000);
            });
        } catch (err) {
            console.error(err);
            btn.textContent = "âŒ å¤±æ•—";
        }
    }

    async function triggerWorkflow() {
        const token = document.getElementById('gh-token').value;
        const status = document.getElementById('update-status');
        const btn = document.getElementById('btn-update');
        if (!token) { alert("GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        localStorage.setItem('gh_pat', token); status.textContent = "é€ä¿¡ä¸­..."; btn.disabled = true;
        try {
            const response = await fetch(`https://api.github.com/repos/Yuzora-Yu/Gold-Checker/actions/workflows/main.yml/dispatches`, {
                method: 'POST',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ ref: 'main' })
            });
            if (response.status === 204) {
                status.textContent = "âœ… é€ä¿¡æˆåŠŸ"; setTimeout(() => { status.textContent = "Update: " + document.getElementById('last-update').textContent; btn.disabled = false; }, 10000);
            } else { status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼"; btn.disabled = false; }
        } catch (e) { status.textContent = "âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼"; btn.disabled = false; }
    }

    refreshData(); setInterval(refreshData, 60000);
</script>
</body>
</html>